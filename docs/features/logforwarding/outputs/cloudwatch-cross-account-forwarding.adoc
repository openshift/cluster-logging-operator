== Cross-account log forwarding using assumeRole

The ClusterLogForwarder supports forwarding logs to an external AWS accounts using AssumeRole functionality. This feature enables centralized logging across multiple AWS accounts while maintaining security boundaries.

=== Cross-Account Overview
Cross-account log forwarding works by:

1. **Initial Authentication**: The ClusterLogForwarder authenticates using either type: `awsAccessKey` or `iamRole`
2. **Role Assumption**: After initial authentication, the forwarder assumes a role in the target (cross) AWS account
3. **Log Forwarding**: Using the assumed role credentials, the logs are forwarded to CloudWatch in the target account

==== AWS IAM Prerequisites
1. **AssumeRole Permissions**: The initial ClusterLogForwarder authentication role must have assumeRole permissions
2. **Logging Permissions**: The assumed role must have CloudWatch Logs permissions in the target account
3. **Trust Policy**: The target (cross) account role must have a trust policy for the ClusterLogForwarder authentication role
4. **External ID** (recommended): Use an external ID for additional security

=== AWS IAM Configuration for Cross-Account Forwarding
1. The ClusterLogForwarder authentication role/user needs permission to assume a role from an external target account
+
.Logging Role/User Permissions Policy (Cluster Account)
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::TARGET-ACCOUNT:role/target-logging-role"
        }
    ]
}
----
2. The target (cross-account) role needs permissions to write logs
+
.Target Role Permissions Policy
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream", 
                "logs:PutLogEvents",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams"
            ],
            "Resource": "*"
        }
    ]
}
----
3. The target (cross-account) requires a trust-policy specifying a `Principal` entity to trust (and optional externalID)
+
.Target Role Trust Policy (Cross-Account)
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::CLUSTER-ACCOUNT:role/cluster-logging-role"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": "my-unique-id-1234"
                }
            }
        }
    ]
}
----

[#_clusterlogforwarder_configuration_for_cross_account_forwarding]
=== ClusterLogForwarder Configuration for Cross-Account Forwarding

.ClusterLogForwarder with AssumeRole
[source,yaml]
----
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: cross-account-example
  namespace: openshift-logging
spec:
  serviceAccount:
    name: my-sa
  outputs:
    - name: cw-cross-account
      type: cloudwatch
      cloudwatch:
        groupName: my-logs-{.log_type||"unknown"}
        region: us-east-1
        authentication:
          type: iamRole
          iamRole:
            roleARN:
              secretName: initial-role-secret
              key: role_arn
            token:
              from: serviceAccount
          # Cross-account assume role configuration
          assumeRole:
            roleARN:
              secretName: cross-account-secret
              key: assume_role_arn
            externalID: "my-unique-id-1234"
  pipelines:
    - name: cross-account-logs
      inputRefs:
        - application
      outputRefs:
        - cw-cross-account
----

==== AssumeRole Fields
`authentication.assumeRole.roleARN` (required)::
Reference to a secret containing the ARN of the role to assume in the target (cross) account.

`authentication.assumeRole.externalID` (optional)::
A string containing the external ID to enforce for assuming the role. This can provide additional security by ensuring only entities with knowledge of the external ID can assume the role.

=== Session Name (automatic generation)
Session names for assumed role sessions are automatically generated by the operator to provide meaningful identification in AWS CloudTrail logs for auditing purposes. The operator generates session names using cluster metadata with the format:

* Primary format: `{clusterId}-{clfName}-{outputName}`
* Fallback format: `output-{outputName}` (if cluster metadata unavailable)
* Always truncated to 64 characters maximum (AWS requirement)
* Uses first 8 characters of cluster ID for uniqueness

.Examples:
* `12345678-my-forwarder-prod-logs` (full format)
* `output-prod-logs` (fallback when cluster ID unavailable)

This automatic generation improves CloudTrail auditing by providing context about which cluster and ClusterLogForwarder initiated the assume role operation, without requiring manual configuration.

=== Cross-Account Security Considerations
1. **External ID**: It is recommended to use external IDs for cross-account role assumptions
2. **Least Privilege**: Grant minimum required permissions to assumed roles
3. **Secret Management**: Protect secrets containing role ARNs and tokens
4. **Monitoring**: Monitor CloudTrail for AssumeRole activities

==== External ID Requirements
The external ID serves as an additional identifier for cross-account access and should be treated with appropriate care.  AWS documentation states that external IDs are "not secrets" because they appear in CloudTrail logs and API responses.

* Must be 2-1224 characters long
* Can contain letters, numbers, and special characters: `=,.@:\/-`
* Should be unique per trust relationship
* Should be unpredictable and not based on public information

=== Long-lived Credentials and AssumeRole
The authentication type `awsAccessKey` can also be used along with the `assumeRole` configuration.  This allows long-lived access keys to be used for the initial assumeRole, and provides an additional layer of least-privilege security for logging permissions.

.Alternate Authentication snippet with AssumeRole
[source,yaml]
----

  outputs:
    - name: key-secret-cross-account
      type: cloudwatch
      cloudwatch:
        authentication:
          type: awsAccessKey
          awsAccessKey:
            keyId:
              secretName: cw-secret
              key: aws_access_key_id
            keySecret:
              secretName: cw-secret
              key: aws_secret_access_key
          # Cross-account assume role configuration
          assumeRole:
            roleARN:
              secretName: cross-account-secret
              key: assume_role_arn
----

=== Troubleshooting
1. **Role Assumption Fails**
   - Verify trust relationship in target account
   - Check external ID matches exactly
   - Ensure initial role has `sts:AssumeRole` permission

2. **Permission Denied**
   - Verify assumed role has CloudWatch permissions
   - Check CloudWatch resource policies
   - Verify region configuration matches

3. **Invalid Role or User ARN**
   - Ensure role ARN format is correct: `arn:aws:iam::ACCOUNT:role/ROLE-NAME`
   - Verify the role exists in the target account

Check Vector pod logs for assume role related errors:
[source,bash]
----
oc logs -n openshift-logging <collector-pod-name>
----

== References
=== Amazon
. [[aws-sts]] https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html[AWS Security Token Service (STS)]
. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html[AWS IAM Roles and Instance Profiles] 