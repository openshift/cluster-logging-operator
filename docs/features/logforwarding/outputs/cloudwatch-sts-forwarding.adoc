= Forwarding to Amazon Cloudwatch using Web Identities From an STS enabled Cluster

This guide provides a workflow for forwarding to Amazon Cloudwatch in an <<aws-sts, STS>> enabled cluster.

These steps assume that there is a <<setup-sts, STS>> enabled openshift cluster running.

---
== Steps to forward to Cloudwatch using Web Identity

=== Creating a `CredentialsRequest`
. Create a `CredentialsRequest` resource with the appropriate actions.
.. This example `CredentialsRequest` allows creating and describing logs.
+
.aws-cred-request.yaml
[source, yaml]
----
apiVersion: cloudcredential.openshift.io/v1
kind: CredentialsRequest
metadata:
  name: my-credrequest # <1>
  namespace: openshift-logging <1>
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: AWSProviderSpec
    statementEntries:
      - action: # <2>
          - logs:PutLogEvents
          - logs:CreateLogGroup
          - logs:PutRetentionPolicy
          - logs:CreateLogStream
          - logs:DescribeLogGroups
          - logs:DescribeLogStreams
        effect: Allow
        resource: arn:aws:logs:*:*:*
  secretRef:
    name: sts-secret # <3>
    namespace: openshift-logging # <3>
  serviceAccountNames:
    - my-sa # <4>
----
<1> The name and namespace for the credentials request.
<2> The allowed actions for this role.
<3> The name and namespace of the secret containing the generated credentials.
<4> The service account(s) that will use the credentials
+

. Create the role in `AWS` using the <<cco, CCO>> utility.
+
```
$ ccoctl aws create-iam-roles --name=<NAME> --region=<REGION> \ # <1>
  --credentials-requests-dir=<REQ DIR> \ # <2>
  --output-dir=<OUTPUT> \ # <3>
  --identity-provider-arn=arn:aws:iam::<AWS_ACCOUNT_ID>:oidc-provider/<NAME>-oidc.s3.<REGION>.amazonaws.com # <4>
```
<1> The name of the resource along with the region
<2> The credentials request directory where the above `CredentialsRequest` YAML is saved.
<3> The output directory
<4> The identity provider arn
+

. Apply the generated credentials secret.
+
.openshift-logging-sts-secret-credentials.yaml
[source, yaml]
----
apiVersion: v1
stringData:
  credentials: |-
    [default]
    sts_regional_endpoints = regional
    role_arn = <MY ROLE ARN>
    web_identity_token_file = <PATH TO SA TOKEN>
kind: Secret
metadata:
  name: sts-secret
  namespace: openshift-logging
type: Opaque
----
+
```
$ oc apply -f openshift-logging-sts-secret-credentials.yaml
```


=== Configuring a `ClusterLogForwarder`

This example forwarder shows two ways to configure a `cloudwatch` output, with a projected service account token or using a secret containing the service account token.

. Create a `ClusterLogForwarder.yaml`
+
.cluster-log-forwarder.yaml
[source,yaml]
----
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: cw-forwarder # <1>
  namespace: openshift-logging # <1>
spec:
  serviceAccount:
    name: my-sa # <2>
  outputs:
    - name: cw-sa-projected-token
      type: cloudwatch
      cloudwatch:
        groupName: 'cw-projected{.log_type||"missing"}' # <3>
        region: us-west-1
        authentication:
          type: iamRole # <4>
          iamRole:
            roleARN: # <5>
              key: credentials # <5>
              secretName: sts-secret # <5>
            token: # <6>
              from: serviceAccount # <6>
    - name: cw-sa-token-secret
      type: cloudwatch
      cloudwatch:
        groupName: 'cw-token-secret{.kubernetes.namespace_name||.log_type||"missing"}'
        region: us-west-1
        authentication:
          type: iamRole
          iamRole:
            roleARN:
              key: role_arn
              secretName: foo-sts-secret
            token:
              from: secret # <7>
              secret:
                key: my-token # <7>
                name: my-sa-token-secret # <7>
  pipelines:
    - name: app-logs
      inputRefs:
        - application
      outputRefs:
        - cw-sa-projected-token
        - cw-sa-token-secret
----
<1> The name and namespace of the forwarder
<2> The service account with the appropriate collection permissions
<3> Group name for the log stream. Can be templated.
<4> The authentication type. For `STS`, use `iamRole`.
<5> The `role_arn` used to authenticate. Specify the name of the secret and the key where the `role_arn` is stored.
<6> The service account token used to authenticate. To use the projected service account token, specify `from: serviceAccount`. 
<7> To use a token from a secret, specify `from: secret` and provide the key and secret name
+

. Apply the configured forwarder.
+
```
$ oc apply -f cluster-log-forwarder.yaml
```

== Cross-Account Log Forwarding

The cluster-logging-operator also supports forwarding logs to Amazon CloudWatch Logs in external AWS accounts using AWS STS AssumeRole functionality. This feature enables centralized logging across multiple AWS accounts while maintaining security boundaries.

=== Cross-Account Overview

Cross-account log forwarding works by:

1. **Initial Authentication**: The collector authenticates to your cluster's AWS account using IAM roles or access keys
2. **Role Assumption**: After initial authentication, the collector assumes a role in the target AWS account  
3. **Log Forwarding**: Using the assumed role's credentials, the collector forwards logs to CloudWatch in the target account

=== Cross-Account Configuration

==== Prerequisites

Before configuring cross-account log forwarding, ensure:

1. **Trust Relationship**: The target account's IAM role must trust your cluster's initial role
2. **Permissions**: The assumed role must have CloudWatch Logs permissions in the target account
3. **External ID** (recommended): Use an external ID for additional security

==== ClusterLogForwarder with AssumeRole

[source,yaml]
----
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: cross-account-example
  namespace: openshift-logging
spec:
  serviceAccount:
    name: my-sa
  outputs:
    - name: target-account-cloudwatch
      type: cloudwatch
      cloudwatch:
        region: us-east-1
        groupName: cross-account-logs
        authentication:
          type: iamRole
          iamRole:
            roleARN:
              secretName: initial-role-secret
              key: role_arn
            token:
              from: serviceAccount
            # Cross-account assume role configuration
            assumeRole:
              roleARN:
                secretName: cross-account-secret
                key: assume_role_arn
              externalID:
                secretName: cross-account-secret
                key: external_id
  pipelines:
    - name: cross-account-logs
      inputRefs:
        - application
      outputRefs:
        - target-account-cloudwatch
----


=== AWS IAM Configuration for Cross-Account Access

==== Initial Role (Cluster Account)

The initial role in your cluster account needs:

[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::TARGET-ACCOUNT:role/target-logging-role"
        }
    ]
}
----

==== Target Role (Target Account)

The target role in the external account needs:

1. **Trust Policy**:

[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::CLUSTER-ACCOUNT:role/initial-role"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": "your-unique-external-id"
                }
            }
        }
    ]
}
----

2. **CloudWatch Permissions**:

[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream", 
                "logs:PutLogEvents",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams"
            ],
            "Resource": "*"
        }
    ]
}
----

=== Cross-Account Security Considerations

1. **External ID**: Always use external IDs for cross-account role assumptions
2. **Least Privilege**: Grant minimum required permissions to assumed roles
3. **Secret Management**: Protect secrets containing role ARNs and external IDs
4. **Monitoring**: Monitor CloudTrail for AssumeRole activities

==== External ID Storage in Secrets

The cluster-logging-operator stores external IDs in Kubernetes secrets for the following security reasons:

**Why Use Secrets for External IDs:**

1. **Defense in Depth**: While AWS documentation suggests external IDs are not "secrets" in the traditional sense, storing them in Kubernetes secrets provides additional security layers including:
   - RBAC-controlled access
   - Encryption at rest (when enabled)
   - Audit logging of secret access
   - Secret rotation capabilities

2. **Consistency**: Role ARNs are already stored in secrets, keeping all assume role parameters together maintains configuration consistency

3. **Namespace Isolation**: Kubernetes secrets provide namespace-level isolation, preventing cross-namespace access to external IDs

4. **Operational Security**: External IDs should be:
   - Unique per trust relationship
   - Not easily guessable
   - Changed if compromised
   - Managed through secure configuration management

**AWS Documentation Context:**

AWS documentation states that external IDs are "not secrets" because they appear in CloudTrail logs and API responses. However, this doesn't mean they should be publicly visible in cluster configurations. The external ID serves as a "password" for cross-account access and should be treated with appropriate care.

**Best Practices for External IDs:**

```yaml
# Generate unique, unpredictable external IDs
apiVersion: v1
kind: Secret
metadata:
  name: cross-account-external-id
  namespace: openshift-logging
stringData:
  external_id: "unique-random-string-generated-per-relationship-2024"
  # Do not use predictable values like account IDs or role names
```

**External ID Requirements:**
- Must be 2-1224 characters long
- Can contain letters, numbers, and special characters: `=,.@:\/-`
- Should be unique per trust relationship
- Should be unpredictable and not based on public information

=== Cross-Account Troubleshooting

==== Common Issues

1. **Role Assumption Fails**
   - Verify trust relationship in target account
   - Check external ID matches exactly
   - Ensure initial role has `sts:AssumeRole` permission

2. **Permission Denied**
   - Verify assumed role has CloudWatch permissions
   - Check CloudWatch resource policies
   - Verify region configuration matches

3. **Invalid Role ARN**
   - Ensure role ARN format is correct: `arn:aws:iam::ACCOUNT:role/ROLE-NAME`
   - Verify the role exists in the target account

Check Collector pod logs for assume role related errors:
[source,bash]
----
kubectl logs -n openshift-logging <collector-pod-name>
----

== References
=== Openshift

. [[setup-sts]] https://github.com/openshift/cloud-credential-operator/blob/master/docs/sts.md[Setting up an STS cluster]
. [[cco]] https://github.com/openshift/cloud-credential-operator[Cloud Credential Operator (CCO)]
. https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/logging/index[Openshift Logging Documentation]

=== Amazon
. [[aws-sts]] https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html[AWS Security Token Service (STS)]
. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html[AWS IAM Roles and Instance Profiles] 