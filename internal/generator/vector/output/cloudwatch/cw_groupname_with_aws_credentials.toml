# Cloudwatch Stream Names
[transforms.cw_normalize_streams]
type = "remap"
inputs = ["cw-forward"]
source = '''
  .stream_name = "default"
  if ( .log_type == "audit" ) {
   .stream_name = (.hostname +"."+ downcase(.log_source)) ?? .stream_name
  }
  if ( .log_source == "Container" ) {
    k = .kubernetes
    .stream_name = (k.namespace_name+"_"+k.pod_name+"_"+k.container_name) ?? .stream_name
  }
  if ( .log_type == "infrastructure" ) {
   .stream_name = ( .hostname + "." + .stream_name ) ?? .stream_name
  }
  if ( .log_source == "Node" ) {
   .stream_name =  ( .hostname + ".journal.system" ) ?? .stream_name
  }
  del(.tag)
  del(.source_type)
'''

# Cloudwatch Groupname
[transforms.cw_group_name]
type = "remap"
inputs = ["cw_normalize_streams"]
source = '''
._internal.cw_group_name = "app-" + to_string!(.log_type||"missing")
'''

# Cloudwatch Logs
[sinks.cw]
type = "aws_cloudwatch_logs"
inputs = ["cw_group_name"]
region = "us-east-test"
compression = "none"
group_name = "{{ _internal.cw_group_name }}"
stream_name = "{{ stream_name }}"
healthcheck.enabled = false

[sinks.cw.encoding]
codec = "json"
except_fields = ["_internal"]