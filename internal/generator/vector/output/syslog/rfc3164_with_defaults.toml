[transforms.example_parse_encoding]
type = "remap"
inputs = ["application"]
source = '''
# set .hostname to the '.host', required by syslog encoder
hostname = to_string(.hostname) ?? ""
if !is_empty(strip_whitespace(hostname)) {
  .host = .hostname
}
._syslog = {}
if .log_type == "infrastructure" && .log_source == "node" {
   ._syslog.app_name = to_string!(.systemd.u.SYSLOG_IDENTIFIER || "")
   ._syslog.proc_id = to_string!(.systemd.t.PID || "")
}
if .log_source == "container" {
   	._syslog.app_name, err = join([.kubernetes.namespace_name, .kubernetes.pod_name, .kubernetes.container_name], "")
   	if err != null {
   	   log("K8s metadata (namespace, pod, or container) missing: unable to calculate syslog.app_name (TAG)", level: "error")
    } else {
  	   #Remove non-alphanumeric characters
  	   ._syslog.app_name = replace(._syslog.app_name, r'[^a-zA-Z0-9]', "")
  	   #Truncate the sanitized tag to 32 characters
  	   ._syslog.app_name = truncate(._syslog.app_name, 32)
  	}
    ._syslog.severity = .level
    ._syslog.facility = "user"
}
if .log_type == "audit" {
   ._syslog.app_name = .log_source
   ._syslog.severity = "informational"
   ._syslog.facility = "security"
}
._syslog.proc_id = to_string!(._syslog.proc_id || "")
if exists(._syslog.proc_id) && is_empty(strip_whitespace(string!(._syslog.proc_id))) { del(._syslog.proc_id) }
._syslog.app_name = to_string!(._syslog.app_name || "")

# try to convert syslog code to the facility, severity names (e.g. 4 -> "warning", "4" -> "warning"  )
if exists(._syslog.facility) {
  _, err = to_syslog_facility_code(._syslog.facility)
  if err != null {
    # Field is not a valid name — try treating it as a code (int or string int)
    code, err2 = to_int(._syslog.facility)
    if err2 == null {
      facility, err3 = to_syslog_facility(code)
      if err3 == null {
        ._syslog.facility = facility
      } else {
        log("Invalid syslog facility code: " + to_string!(._syslog.facility) , level: "warn")
      }
    } else {
      log("Invalid syslog facility value: " + to_string!(._syslog.facility), level: "warn")
    }
  }
  # else: already a valid name, leave it as-is
}

if exists(._syslog.severity) {
  _, err = to_syslog_severity(._syslog.severity)
  if err != null {
    # Field is not a valid name — try treating it as a code (int or string int)
    code, err2 = to_int(._syslog.severity)
    if err2 == null {
      severity, err3 = to_syslog_level(code)
      if err3 == null {
        ._syslog.severity = severity
      } else {
        log("Invalid syslog severity code: " + to_string!(._syslog.severity), level: "warn")
      }
    } else {
      log("Invalid syslog severity value: " + to_string!(._syslog.severity), level: "warn")
    }
  }
  # else: already a valid name, leave it as-is
}
'''

[sinks.example]
type = "socket"
inputs = ["example_parse_encoding"]
address = "logserver:514"
mode = "udp"

[sinks.example.encoding]
codec = "syslog"
except_fields = ["_internal"]
syslog.rfc = "rfc3164"
syslog.facility = "._syslog.facility"
syslog.severity = "._syslog.severity"
syslog.app_name = "._syslog.app_name"
syslog.proc_id = "._syslog.proc_id"
