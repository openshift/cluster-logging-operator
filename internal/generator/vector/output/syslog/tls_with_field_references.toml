[transforms.example_parse_encoding]
type = "remap"
inputs = ["application"]
source = '''
# set .hostname to the '.host', required by syslog encoder
hostname = to_string(.hostname) ?? ""
if !is_empty(strip_whitespace(hostname)) {
  .host = .hostname
}
._syslog = {}
._syslog.facility = to_string!(._internal.structured.facility||"user")
._syslog.severity = to_string!(._internal.structured.severity||"informational")
._syslog.proc_id = to_string!(._internal.structured proc_id||"none")
._syslog.app_name = to_string!(._internal.structured.app_name||"none")
._syslog.msg_id = to_string!(._internal.structured.msg_id||"none")

# try to convert syslog code to the facility, severity names (e.g. 4 -> "warning", "4" -> "warning"  )
if exists(._syslog.facility) {
  _, err = to_syslog_facility_code(._syslog.facility)
  if err != null {
    # Field is not a valid name — try treating it as a code (int or string int)
    code, err2 = to_int(._syslog.facility)
    if err2 == null {
      facility, err3 = to_syslog_facility(code)
      if err3 == null {
        ._syslog.facility = facility
      } else {
        log("Invalid syslog facility code: " + to_string!(._syslog.facility) , level: "warn")
      }
    } else {
      log("Invalid syslog facility value: " + to_string!(._syslog.facility), level: "warn")
    }
  }
  # else: already a valid name, leave it as-is
}

if exists(._syslog.severity) {
  _, err = to_syslog_severity(._syslog.severity)
  if err != null {
    # Field is not a valid name — try treating it as a code (int or string int)
    code, err2 = to_int(._syslog.severity)
    if err2 == null {
      severity, err3 = to_syslog_level(code)
      if err3 == null {
        ._syslog.severity = severity
      } else {
        log("Invalid syslog severity code: " + to_string!(._syslog.severity), level: "warn")
      }
    } else {
      log("Invalid syslog severity value: " + to_string!(._syslog.severity), level: "warn")
    }
  }
  # else: already a valid name, leave it as-is
}
'''

[sinks.example]
type = "socket"
inputs = ["example_parse_encoding"]
address = "logserver:6514"
mode = "tcp"
keepalive.time_secs = 60

[sinks.example.encoding]
codec = "syslog"
except_fields = ["_internal"]
syslog.rfc = "rfc5424"
syslog.facility = "._syslog.facility"
syslog.severity = "._syslog.severity"
syslog.app_name = "._syslog.app_name"
syslog.proc_id = "._syslog.proc_id"
syslog.msg_id = "._syslog.msg_id"

[sinks.example.tls]
enabled = true
key_file = "/var/run/ocp-collector/secrets/syslog-tls/tls.key"
crt_file = "/var/run/ocp-collector/secrets/syslog-tls/tls.crt"
ca_file = "/var/run/ocp-collector/secrets/syslog-tls/ca-bundle.crt"
key_pass = "mysecretpassword"